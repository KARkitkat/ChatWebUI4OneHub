<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video API 测试 - kie.ai - TOPglobai</title>
    <style>
        :root {
            --primary: #4facfe;
            --primary-end: #00f2fe;
            --pill-active: linear-gradient(135deg, #0ea5e9, #2563eb);
            --bg-color: #ffffff;
            --card-border: rgba(79, 172, 254, 0.25);
            --text: #111827;
            --muted: #6b7280;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --disabled: #9ca3af;
        }

        * { box-sizing: border-box; }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100%;
            color: var(--text);
        }

        .bg-decoration {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200vw;
            height: 200vh;
            transform: translate(-50%, -50%) rotate(-12deg);
            z-index: 0;
            background: radial-gradient(ellipse 80% 50% at 50% 50%, rgba(79, 172, 254, 0.06) 0%, transparent 60%);
            pointer-events: none;
        }

        .main-wrapper {
            position: relative;
            z-index: 10;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 24px 60px;
        }

        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .back-link {
            color: var(--muted);
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--primary); }

        .brand-mini {
            font-weight: 700;
            font-size: 18px;
            background: linear-gradient(to right, var(--primary), var(--primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-logo {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: inherit;
        }

        .nav-logo img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: contain;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: clamp(1.75rem, 4vw, 2.25rem);
            font-weight: 800;
            color: var(--text);
            margin: 0 0 12px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--muted);
            font-size: 1rem;
            margin: 0;
            line-height: 1.5;
        }

        .main-card {
            background: #fff;
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
        }

        .form-group { margin-bottom: 24px; }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            background: #fff;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .form-input::placeholder { color: var(--muted); }

        .form-hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: var(--pill-active);
            color: #fff;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.35);
        }

        .btn:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }

        .btn:active { transform: translateY(0); }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #fff;
            color: var(--text);
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 24px;
        }

        .result-area { margin-top: 32px; }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 999px;
            background: #f3f4f6;
            color: var(--muted);
        }

        .status-indicator.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .status-indicator.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .status-indicator.loading {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-indicator.waiting {
            background: rgba(79, 172, 254, 0.1);
            color: var(--primary);
        }

        .loading-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error-message {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 16px;
            color: var(--error);
            font-size: 14px;
            line-height: 1.5;
        }

        .error-title { font-weight: 600; margin-bottom: 8px; }

        .task-info {
            background: #f8fafc;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
        }

        .task-info strong { color: var(--text); }

        .json-block {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .video-result {
            margin-top: 16px;
        }

        .video-result video {
            width: 100%;
            max-width: 560px;
            border-radius: 12px;
            background: #000;
        }

        .video-link {
            display: inline-block;
            margin-top: 8px;
            color: var(--primary);
            font-size: 14px;
            text-decoration: none;
        }

        .video-link:hover { text-decoration: underline; }

        .radio-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .radio-group label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 15px;
            color: var(--text);
        }

        .radio-group input[type="radio"],
        .radio-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-half {
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 600px) {
            .main-wrapper { padding: 24px 16px 40px; }
            .main-card { padding: 24px; }
            .btn-row { flex-direction: column; }
            .form-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="bg-decoration"></div>

    <div class="main-wrapper">
        <nav class="top-nav">
            <a href="https://topglobai.com/" class="back-link">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                返回首页
            </a>
            <a href="https://topglobai.com/" class="nav-logo" aria-label="TOPglobai 首页">
                <img src="https://img.topglobai.com/logomain2.png" alt="TOPglobai">
                <span class="brand-mini">TOPglobai</span>
            </a>
        </nav>

        <header class="header">
            <h1 class="title">Video API 测试</h1>
            <p class="subtitle">kie.ai · 创建任务并查询视频生成状态与结果</p>
        </header>

        <div class="main-card">
            <form id="videoApiForm">
                <div class="form-group">
                    <label for="apiBase" class="form-label">API 地址</label>
                    <input type="url" id="apiBase" class="form-input" placeholder="https://api.kie.ai" value="https://api.kie.ai" required>
                    <p class="form-hint">Base URL，无需带路径。例如：https://api.kie.ai</p>
                </div>

                <div class="form-group">
                    <label for="apiKey" class="form-label">API Key</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="您的 API Key" value="42492a10f6e235c91bfa3430b3df7b03" required>
                    <p class="form-hint">请求头：Authorization: Bearer YOUR_API_KEY</p>
                </div>

                <div class="form-group">
                    <label class="form-label">生成模式 (mode)</label>
                    <div class="radio-group">
                        <label><input type="radio" name="mode" value="std" checked> std（标准分辨率）</label>
                        <label><input type="radio" name="mode" value="pro"> pro（更高分辨率）</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="imageUrls" class="form-label">image_urls（必填）</label>
                    <textarea id="imageUrls" class="form-input" rows="3" placeholder="每行一个图片 URL&#10;例如：https://static.aiquickdraw.com/tools/example/1764851002741_i0lEiI8I.png">https://img.topglobai.com/testpage/a.jpg</textarea>
                    <p class="form-hint">输入图片 URL 列表，每行一个或逗号分隔，至少填一个。</p>
                </div>

                <div class="form-group">
                    <label for="prompt" class="form-label">prompt（必填）</label>
                    <textarea id="prompt" class="form-input" rows="2" placeholder="描述视频内容，可用 @元素名 引用 kling_elements，如：In a bright room@element_dog" required>镜头缓慢推进</textarea>
                </div>

                <div class="form-group form-row">
                    <div class="form-half">
                        <label for="duration" class="form-label">duration</label>
                        <input type="text" id="duration" class="form-input" placeholder="5" value="5">
                        <p class="form-hint">时长，如 "5"</p>
                    </div>
                    <div class="form-half">
                        <label for="aspectRatio" class="form-label">aspect_ratio</label>
                        <select id="aspectRatio" class="form-input">
                            <option value="16:9">16:9</option>
                            <option value="9:16">9:16</option>
                            <option value="1:1">1:1</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="radio-group">
                        <label><input type="checkbox" id="sound" checked> sound（带声音）</label>
                        <label><input type="checkbox" id="multiShots"> multi_shots（多镜头）</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="klingElements" class="form-label">kling_elements（可选，JSON 数组）</label>
                    <textarea id="klingElements" class="form-input" rows="4" placeholder='[{"name":"element_dog","description":"dog","element_input_urls":["https://...","https://..."]}]'></textarea>
                    <p class="form-hint">元素数组，prompt 中可用 @name 引用。留空则不传。</p>
                </div>

                <div class="form-group">
                    <label for="callBackUrl" class="form-label">callBackUrl（可选）</label>
                    <input type="url" id="callBackUrl" class="form-input" placeholder="https://your-domain.com/api/callback">
                    <p class="form-hint">任务完成时接收 POST 通知；不填则需轮询查询状态。</p>
                </div>

                <div class="btn-row">
                    <button type="submit" class="btn" id="createTaskBtn">创建生成任务</button>
                    <button type="button" class="btn btn-secondary" id="clearBtn">清空配置</button>
                </div>
            </form>
        </div>

        <div class="main-card" id="taskCard" style="display: none;">
            <div class="result-area">
                <div class="result-header">
                    <h2 class="result-title">任务信息</h2>
                    <div class="status-indicator" id="statusIndicator">等待中</div>
                </div>
                <div id="taskIdBlock" class="task-info" style="display: none;">
                    <strong>Task ID：</strong><span id="displayTaskId"></span>
                </div>
                <div class="btn-row">
                    <button type="button" class="btn btn-secondary" id="queryTaskBtn" style="display: none;">查询任务状态</button>
                    <button type="button" class="btn btn-secondary" id="pollTaskBtn" style="display: none;">自动轮询状态</button>
                    <button type="button" class="btn btn-secondary" id="stopPollBtn" style="display: none;">停止轮询</button>
                </div>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const API_BASE_KEY = 'videoApi_base';
            const API_KEY_KEY = 'videoApi_key';

            const form = document.getElementById('videoApiForm');
            const apiBaseInput = document.getElementById('apiBase');
            const apiKeyInput = document.getElementById('apiKey');
            const callBackUrlInput = document.getElementById('callBackUrl');
            const imageUrlsInput = document.getElementById('imageUrls');
            const promptInput = document.getElementById('prompt');
            const durationInput = document.getElementById('duration');
            const aspectRatioInput = document.getElementById('aspectRatio');
            const soundInput = document.getElementById('sound');
            const multiShotsCheckbox = document.getElementById('multiShots');
            const klingElementsInput = document.getElementById('klingElements');
            const createTaskBtn = document.getElementById('createTaskBtn');
            const clearBtn = document.getElementById('clearBtn');
            const taskCard = document.getElementById('taskCard');
            const taskIdBlock = document.getElementById('taskIdBlock');
            const displayTaskId = document.getElementById('displayTaskId');
            const statusIndicator = document.getElementById('statusIndicator');
            const resultContent = document.getElementById('resultContent');
            const queryTaskBtn = document.getElementById('queryTaskBtn');
            const pollTaskBtn = document.getElementById('pollTaskBtn');
            const stopPollBtn = document.getElementById('stopPollBtn');

            let currentTaskId = null;
            let pollTimer = null;

            function getBaseUrl() {
                return apiBaseInput.value.trim().replace(/\/$/, '');
            }

            function getAuthHeader() {
                return { 'Authorization': 'Bearer ' + apiKeyInput.value.trim() };
            }

            function getMode() {
                return document.querySelector('input[name="mode"]:checked').value;
            }

            function showStatus(type, message) {
                statusIndicator.className = 'status-indicator ' + type;
                var icon = '';
                if (type === 'loading') icon = '<div class="loading-spinner"></div>';
                else if (type === 'success') icon = '✓ ';
                else if (type === 'error') icon = '✗ ';
                statusIndicator.innerHTML = icon + message;
            }

            function showError(msg) {
                resultContent.innerHTML = '<div class="error-message"><div class="error-title">错误</div><div>' + (msg || '未知错误') + '</div></div>';
            }

            function showResult(data) {
                if (!data || !data.data) {
                    resultContent.innerHTML = '<div class="json-block">' + (data ? JSON.stringify(data, null, 2) : '无数据') + '</div>';
                    return;
                }
                var d = data.data;
                var state = d.state || '';
                var html = '<div class="json-block">' + JSON.stringify(data, null, 2) + '</div>';

                if (state === 'success' && d.resultJson) {
                    try {
                        var result = JSON.parse(d.resultJson);
                        if (result.resultUrls && result.resultUrls.length) {
                            html += '<div class="video-result">';
                            result.resultUrls.forEach(function (url) {
                                html += '<div><video src="' + url + '" controls preload="metadata"></video>';
                                html += '<a class="video-link" href="' + url + '" target="_blank" rel="noopener">在新窗口打开视频</a></div>';
                            });
                            html += '</div>';
                        }
                    } catch (e) {
                        html += '<p class="form-hint">resultJson 解析失败：' + e.message + '</p>';
                    }
                }

                resultContent.innerHTML = html;
            }

            function loadSaved() {
                try {
                    var base = localStorage.getItem(API_BASE_KEY);
                    var key = localStorage.getItem(API_KEY_KEY);
                    if (base) apiBaseInput.value = base;
                    if (key) apiKeyInput.value = key;
                } catch (e) {}
            }

            function saveConfig() {
                try {
                    localStorage.setItem(API_BASE_KEY, apiBaseInput.value);
                    localStorage.setItem(API_KEY_KEY, apiKeyInput.value);
                } catch (e) {}
            }

            function parseUrlList(raw) {
                return (raw || '').trim()
                    .split(/[\n,，]+/)
                    .map(function (s) { return s.trim(); })
                    .filter(Boolean);
            }

            // 创建任务
            async function createTask() {
                var base = getBaseUrl();
                var key = apiKeyInput.value.trim();
                if (!base || !key) {
                    showError('请填写 API 地址和 API Key');
                    return;
                }

                var imageUrls = parseUrlList(imageUrlsInput.value);
                if (!imageUrls.length) {
                    showStatus('error', '创建失败');
                    showError('image_urls 不能为空，请至少填写一个图片 URL。');
                    return;
                }

                var prompt = (promptInput.value || '').trim();
                if (!prompt) {
                    showStatus('error', '创建失败');
                    showError('prompt is required（prompt 必填），请填写视频描述。');
                    return;
                }

                var mode = getMode();
                var input = {
                    mode: mode,
                    image_urls: imageUrls,
                    sound: soundInput.checked,
                    duration: (durationInput.value || '5').trim() || '5',
                    aspect_ratio: aspectRatioInput.value || '16:9',
                    multi_shots: multiShotsCheckbox.checked,
                    prompt: prompt
                };

                var klingRaw = (klingElementsInput.value || '').trim();
                if (klingRaw) {
                    try {
                        var kling = JSON.parse(klingRaw);
                        if (Array.isArray(kling) && kling.length) input.kling_elements = kling;
                    } catch (e) {
                        showStatus('error', '创建失败');
                        showError('kling_elements JSON 格式错误：' + e.message);
                        return;
                    }
                }

                var body = { model: 'kling-3.0/video', input: input };
                var callback = callBackUrlInput.value.trim();
                if (callback) body.callBackUrl = callback;

                createTaskBtn.disabled = true;
                showStatus('loading', '创建任务中...');
                taskCard.style.display = 'block';
                taskIdBlock.style.display = 'none';
                queryTaskBtn.style.display = 'none';
                pollTaskBtn.style.display = 'none';
                stopPollBtn.style.display = 'none';
                resultContent.innerHTML = '<div class="form-label" style="margin-bottom:8px;">本次请求 Body</div><div class="json-block">' + JSON.stringify(body, null, 2) + '</div><div id="createTaskResponse" style="margin-top:16px;"></div>';

                try {
                    var url = base + '/api/v1/jobs/createTask';
                    var res = await fetch(url, {
                        method: 'POST',
                        headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeader()),
                        body: JSON.stringify(body)
                    });
                    var data = await res.json();

                    if (data.code !== 200) {
                        throw new Error(data.msg || '创建失败：' + (data.failMsg || res.status));
                    }
                    if (!data.data || !data.data.taskId) {
                        throw new Error('响应中缺少 taskId');
                    }

                    currentTaskId = data.data.taskId;
                    displayTaskId.textContent = currentTaskId;
                    taskIdBlock.style.display = 'block';
                    queryTaskBtn.style.display = 'inline-flex';
                    pollTaskBtn.style.display = 'inline-flex';
                    showStatus('success', '任务已创建');
                    var respEl = document.getElementById('createTaskResponse');
                    if (respEl) respEl.innerHTML = '<div class="form-label" style="margin-bottom:8px;">响应结果</div><div class="json-block">' + JSON.stringify(data, null, 2) + '</div>';
                    else resultContent.innerHTML = '<div class="form-label" style="margin-bottom:8px;">响应结果</div><div class="json-block">' + JSON.stringify(data, null, 2) + '</div>';
                    saveConfig();
                } catch (e) {
                    showStatus('error', '创建失败');
                    var respEl = document.getElementById('createTaskResponse');
                    if (respEl) respEl.innerHTML = '<div class="form-label" style="margin-bottom:8px;">错误</div><div class="error-message">' + (e.message || String(e)) + '</div>';
                    else showError(e.message || String(e));
                } finally {
                    createTaskBtn.disabled = false;
                }
            }

            // 查询任务状态
            async function queryTask() {
                if (!currentTaskId) {
                    showError('请先创建任务');
                    return;
                }
                var base = getBaseUrl();
                queryTaskBtn.disabled = true;
                showStatus('loading', '查询中...');
                try {
                    var url = base + '/api/v1/jobs/recordInfo?taskId=' + encodeURIComponent(currentTaskId);
                    var res = await fetch(url, { headers: getAuthHeader() });
                    var data = await res.json();
                    if (data.code !== 200) {
                        throw new Error(data.msg || '查询失败');
                    }
                    var state = (data.data && data.data.state) || '';
                    if (state === 'success') showStatus('success', '已完成');
                    else if (state === 'fail') showStatus('error', '任务失败');
                    else showStatus('waiting', state || '等待中');
                    showResult(data);
                } catch (e) {
                    showStatus('error', '查询失败');
                    showError(e.message || String(e));
                } finally {
                    queryTaskBtn.disabled = false;
                }
            }

            function stopPoll() {
                if (pollTimer) {
                    clearInterval(pollTimer);
                    pollTimer = null;
                }
                pollTaskBtn.style.display = 'inline-flex';
                stopPollBtn.style.display = 'none';
            }

            function startPoll() {
                if (!currentTaskId) return;
                pollTaskBtn.style.display = 'none';
                stopPollBtn.style.display = 'inline-flex';
                var base = getBaseUrl();
                showStatus('loading', '轮询中...');

                function doPoll() {
                    if (!currentTaskId) return;
                    fetch(base + '/api/v1/jobs/recordInfo?taskId=' + encodeURIComponent(currentTaskId), { headers: getAuthHeader() })
                        .then(function (res) { return res.json(); })
                        .then(function (data) {
                            if (data.code !== 200) return;
                            var d = data.data;
                            var state = (d && d.state) || '';
                            if (state === 'success') {
                                stopPoll();
                                showStatus('success', '已完成');
                                showResult(data);
                                return;
                            }
                            if (state === 'fail') {
                                stopPoll();
                                showStatus('error', '任务失败');
                                showResult(data);
                                return;
                            }
                            showStatus('loading', '状态: ' + state);
                            showResult(data);
                        })
                        .catch(function () {
                            showStatus('error', '轮询请求失败');
                        });
                }

                doPoll();
                pollTimer = setInterval(doPoll, 3000);
            }

            function clearForm() {
                apiBaseInput.value = 'https://api.kie.ai';
                apiKeyInput.value = '42492a10f6e235c91bfa3430b3df7b03';
                callBackUrlInput.value = '';
                imageUrlsInput.value = 'https://img.topglobai.com/testpage/a.jpg';
                promptInput.value = '镜头缓慢推进';
                durationInput.value = '5';
                aspectRatioInput.value = '16:9';
                soundInput.checked = true;
                multiShotsCheckbox.checked = false;
                klingElementsInput.value = '';
                document.querySelector('input[name="mode"][value="std"]').checked = true;
                taskCard.style.display = 'none';
                currentTaskId = null;
                stopPoll();
                try {
                    localStorage.removeItem(API_BASE_KEY);
                    localStorage.removeItem(API_KEY_KEY);
                } catch (e) {}
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                createTask();
            });
            clearBtn.addEventListener('click', clearForm);
            queryTaskBtn.addEventListener('click', queryTask);
            pollTaskBtn.addEventListener('click', startPoll);
            stopPollBtn.addEventListener('click', stopPoll);

            loadSaved();
        })();
    </script>
</body>
</html>
